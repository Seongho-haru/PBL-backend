version: '3.8'

# Default logging configuration
x-logging: &default-logging
  logging:
    driver: json-file
    options:
      max-size: 100M
      max-file: "3"

services:
  # Judge0 Spring Boot API Server
#  judge0-api:
#    build:
#      context: .
#      target: production
#    image: judge0/judge0-spring:latest
#    container_name: judge0-api
#    restart: unless-stopped
#    ports:
#      - "2358:2358"
#      - "8081:8081"  # JobRunr dashboard
#    environment:
#      # Database
#      - POSTGRES_HOST=db
#      - POSTGRES_PORT=5432
#      - POSTGRES_DB=judge0
#      - POSTGRES_USER=judge0
#      - POSTGRES_PASSWORD=judge0pass
#
#      # Redis
#      - REDIS_HOST=redis
#      - REDIS_PORT=6379
#      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
#
#      # Docker
#      - DOCKER_HOST=unix:///var/run/docker.sock
#
#      # Profiles
#      - SPRING_PROFILES_ACTIVE=docker
#
#      # Judge0 Configuration
#      - MAINTENANCE_MODE=${MAINTENANCE_MODE:-false}
#      - ENABLE_WAIT_RESULT=${ENABLE_WAIT_RESULT:-true}
#      - ENABLE_COMPILER_OPTIONS=${ENABLE_COMPILER_OPTIONS:-true}
#      - ENABLE_COMMAND_LINE_ARGUMENTS=${ENABLE_COMMAND_LINE_ARGUMENTS:-true}
#      - ENABLE_SUBMISSION_DELETE=${ENABLE_SUBMISSION_DELETE:-false}
#      - ENABLE_CALLBACKS=${ENABLE_CALLBACKS:-true}
#      - ENABLE_ADDITIONAL_FILES=${ENABLE_ADDITIONAL_FILES:-true}
#      - ENABLE_BATCHED_SUBMISSIONS=${ENABLE_BATCHED_SUBMISSIONS:-true}
#      - ALLOW_ENABLE_NETWORK=${ALLOW_ENABLE_NETWORK:-true}
#      - ENABLE_NETWORK=${ENABLE_NETWORK:-false}
#
#      # Limits
#      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-100}
#      - CPU_TIME_LIMIT=${CPU_TIME_LIMIT:-5.0}
#      - MAX_CPU_TIME_LIMIT=${MAX_CPU_TIME_LIMIT:-15.0}
#      - WALL_TIME_LIMIT=${WALL_TIME_LIMIT:-10.0}
#      - MAX_WALL_TIME_LIMIT=${MAX_WALL_TIME_LIMIT:-20.0}
#      - MEMORY_LIMIT=${MEMORY_LIMIT:-128000}
#      - MAX_MEMORY_LIMIT=${MAX_MEMORY_LIMIT:-512000}
#
#      # Workers
#      - WORKER_COUNT=${WORKER_COUNT:-4}
#      - MAX_CONCURRENT_CONTAINERS=${MAX_CONCURRENT_CONTAINERS:-10}
#
#      # Security
#      - ALLOW_ORIGIN=${ALLOW_ORIGIN:-}
#      - DISALLOW_ORIGIN=${DISALLOW_ORIGIN:-}
#
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
#      - judge0_logs:/app/logs
#    depends_on:
#      - db
#      - redis
#    privileged: true  # Required for Docker-in-Docker
#    <<: *default-logging
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost:2358/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 60s

  # PostgreSQL Database
  db:
    image: postgres:16.2-alpine
    container_name: judge0-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-judge0pass}
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    <<: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U judge0 -d judge0"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache and Queue
  redis:
    image: redis:7.2.4-alpine
    container_name: judge0-redis
    restart: unless-stopped
    command: >
      redis-server 
      --appendonly yes 
      --requirepass "${REDIS_PASSWORD:-}"
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - judge0_redis_data:/data
    ports:
      - "6379:6379"
    <<: *default-logging
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus (Optional - for monitoring)
#  prometheus:
#    image: prom/prometheus:latest
#    container_name: judge0-prometheus
#    restart: unless-stopped
#    ports:
#      - "9090:9090"
#    volumes:
#      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
#      - judge0_prometheus_data:/prometheus
#    command:
#      - '--config.file=/etc/prometheus/prometheus.yml'
#      - '--storage.tsdb.path=/prometheus'
#      - '--web.console.libraries=/etc/prometheus/console_libraries'
#      - '--web.console.templates=/etc/prometheus/consoles'
#      - '--storage.tsdb.retention.time=200h'
#      - '--web.enable-lifecycle'
#    profiles: ["monitoring"]
#    <<: *default-logging
#
#  # Grafana (Optional - for monitoring)
#  grafana:
#    image: grafana/grafana:latest
#    container_name: judge0-grafana
#    restart: unless-stopped
#    ports:
#      - "3000:3000"
#    environment:
#      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
#      - GF_USERS_ALLOW_SIGN_UP=false
#    volumes:
#      - judge0_grafana_data:/var/lib/grafana
#      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
#      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
#    profiles: ["monitoring"]
#    <<: *default-logging

volumes:
  judge0_postgres_data:
    driver: local
  judge0_redis_data:
    driver: local
  judge0_logs:
    driver: local
  judge0_prometheus_data:
    driver: local
  judge0_grafana_data:
    driver: local

networks:
  default:
    name: judge0-network
