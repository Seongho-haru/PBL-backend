version: "3.8"

# Default logging configuration
x-logging: &default-logging
  logging:
    driver: json-file
    options:
      max-size: 100M
      max-file: "3"

services:
  # Watchtower for automatic container updates
#  watchtower:
#    image: containrrr/watchtower:latest
#    container_name: watchtower
#    restart: unless-stopped
#    environment:
#      - WATCHTOWER_POLL_INTERVAL=300 # Check every 5 minutes
#      - WATCHTOWER_CLEANUP=true # Remove old images
#      - WATCHTOWER_INCLUDE_STOPPED=true
#      - WATCHTOWER_REVIVE_STOPPED=true
#      - WATCHTOWER_NOTIFICATIONS=slack
#      - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${SLACK_WEBHOOK_URL}
#      - WATCHTOWER_NOTIFICATION_SLACK_IDENTIFIER=watchtower-pbl
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
#    command: --interval 300 --cleanup --include-stopped --revive-stopped
#    <<: *default-logging

  # PBL Backend Application (로컬 개발용 - gradlew bootRun 사용)
  # pbl-backend:
  #   image: ${REGISTRY:-icn.ocir.io}/${OCI_NAMESPACE}/pbl-backend:latest
  #   container_name: pbl-backend
  #   restart: unless-stopped
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=production
  #     - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/judge0
  #     - SPRING_DATASOURCE_USERNAME=judge0
  #     - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
  #     - SPRING_REDIS_HOST=redis
  #     - SPRING_REDIS_PORT=6379
  #     - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
  #     - MINIO_ENDPOINT=http://minio:9000
  #     - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
  #     - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
  #     - CHROMA_HOST=chromadb
  #     - CHROMA_PORT=8000
  #   ports:
  #     - "2358:2358"
  #   depends_on:
  #     - db
  #     - redis
  #     - chromadb
  #     - minio
  #   <<: *default-logging
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:2358/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 60s

  # PostgreSQL Database
  db:
    image: postgres:16.2-alpine
    container_name: judge0-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-judge0pass}
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    <<: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U judge0 -d judge0"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache and Queue
  redis:
    image: redis:7.2.4-alpine
    container_name: judge0-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass "${REDIS_PASSWORD:-}"
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - judge0_redis_data:/data
    ports:
      - "6379:6379"
    <<: *default-logging
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ChromaDB Vector Database
  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb
    restart: unless-stopped
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=${ANONYMIZED_TELEMETRY:-TRUE}
    volumes:
      - chroma_data:/chroma/chroma
    ports:
      - "8000:8000"
    <<: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3

  chroma-mcp:
    image: chroma-mcp:latest  # 이미 빌드된 이미지 사용
    container_name: chroma-mcp
    restart: unless-stopped
    environment:
      - CHROMA_CLIENT_TYPE=persistent
      - CHROMA_DATA_DIR=/data
    volumes:
      - /Volumes/SamsungSSD/chroma_db:/data
    command: tail -f /dev/null
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin123}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000" # API port
      - "9001:9001" # Console port
    command: server /data --console-address ":9001"
    <<: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  judge0_postgres_data:
    driver: local
  judge0_redis_data:
    driver: local
  chroma_data:
    driver: local
  minio_data:
    driver: local
networks:
  default:
    name: judge0-network
