#!/bin/bash

# Judge0 Spring Boot Server Start Script

set -e

# Source configuration if available
if [ -f "./judge0.conf" ]; then
    source ./judge0.conf
fi

# Default values
PORT=${PORT:-2358}
SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-development}
JAVA_OPTS=${JAVA_OPTS:-"-Xmx1g -Xms512m"}

echo "Starting Judge0 Spring Boot Server..."
echo "Port: $PORT"
echo "Profile: $SPRING_PROFILES_ACTIVE"
echo "Java Options: $JAVA_OPTS"

# Check if JAR file exists
JAR_FILE=$(find . -name "judge0-spring*.jar" | head -1)

if [ -z "$JAR_FILE" ]; then
    echo "Building application..."
    ./gradlew build -x test
    JAR_FILE=$(find build/libs -name "judge0-spring*.jar" | head -1)
fi

if [ -z "$JAR_FILE" ]; then
    echo "Error: JAR file not found. Please build the application first."
    exit 1
fi

echo "Starting application: $JAR_FILE"

# Start the application
exec java $JAVA_OPTS \
    -Dserver.port=$PORT \
    -Dspring.profiles.active=$SPRING_PROFILES_ACTIVE \
    -jar "$JAR_FILE"
