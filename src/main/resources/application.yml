spring:
  application:
    name: judge0-spring
  datasource:
    url: jdbc:postgresql://localhost:5432/judge0
    username: judge0
    password: ${POSTGRES_PASSWORD:judge0pass}
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: none
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
    open-in-view: false
  # Cache Configuration (Simple in-memory)
  cache:
    type: simple

  # Task Execution
  task:
    execution:
      pool:
        core-size: 4
        max-size: 8
        queue-capacity: 50
        keep-alive: 60s

  # File Upload Configuration
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB
      enabled: true

  # Flyway Configuration - DISABLED for demo
  flyway:
    enabled: true
    clean-disabled: false
    locations:
      - classpath:db/migration
      - classpath:db/migration/postgresql

# OpenAI
langchain4j:
  http-client:
    type: spring-rest-client
  chat-model:
    api-key: ??
    model-name: gpt-4o-mini
    embedding-model-name: text-embedding-3-small
  chroma:
    url: http://localhost:8000
org:
  jobrunr:
    background-job-server:
      enabled: true
      worker-count: 4
      poll-interval-in-seconds: 5 # 폴링 간격 1초로 설정
    dashboard:
      enabled: false
      port: 8081
    jobs:
      default-number-of-retries: 3

# Server Configuration
server:
  port: 2358
  servlet:
    context-path: /
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain

# Management/Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
    metrics:
      enabled: true

# SpringDoc OpenAPI Configuration
springdoc:
  api-docs:
    path: /api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operationsSorter: method
    tagsSorter: alpha
    tryItOutEnabled: true
    filter: true
    displayRequestDuration: true
    urls: # 모듈 추가시 이곳에 추가
      - name: "All APIs"
        url: /api-docs
      - name: "Judge0 Core APIs"
        url: /api-docs/judge0-core
      - name: "Lecture Management APIs"
        url: /api-docs/lectures
      - name: "Curriculum Management APIs"
        url: /api-docs/curriculums
      - name: "Authentication APIs"
        url: /api-docs/auth
      - name: "Grading System APIs"
        url: /api-docs/grading
      - name: "S3 Image Management APIs"
        url: /api-docs/s3
  show-actuator: true
  packages-to-scan: com.PBL # 전체 PBL 패키지 자동 스캔
  group-configs:
    - group: "judge0-core"
      display-name: "Judge0 Core APIs"
      paths-to-match:
        - /submissions/**
        - /languages/**
        - /statuses/**
        - /system_info/**
        - /health/**
    - group: "lectures"
      display-name: "Lecture Management APIs"
      paths-to-match:
        - /api/lectures/**
      packages-to-scan:
        - com.PBL.lecture
    - group: "curriculums"
      display-name: "Curriculum Management APIs"
      paths-to-match:
        - /api/curriculums/**
      packages-to-scan:
        - com.PBL.curriculum
    - group: "auth"
      display-name: "Authentication APIs"
      paths-to-match:
        - /api/auth/**
      packages-to-scan:
        - com.PBL.user
    - group: "grading"
      display-name: "Grading System APIs"
      paths-to-match:
        - /grading/**
    - group: "s3"
      display-name: "S3 Image Management APIs"
      paths-to-match:
        - /api/s3/**
      packages-to-scan:
        - com.PBL.s3

# Logging Configuration
logging:
  level:
    com.judge0: INFO
    com.PBL.lecture: DEBUG
    org.springframework.web: WARN
    org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping: DEBUG
    org.springdoc: DEBUG
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
    com.github.dockerjava: WARN
    org.jobrunr: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/judge0-spring.log
    max-size: 100MB
    max-history: 30

# Judge0 Configuration
judge0:
  # System Configuration
  maintenance:
    mode: false
    message: "Judge0 is currently in maintenance."

  # Feature Flags
  features:
    enable-wait-result: true
    enable-compiler-options: true
    enable-command-line-arguments: true
    enable-submission-delete: false
    enable-callbacks: true
    enable-additional-files: true
    enable-batched-submissions: true
    allow-enable-network: true
    enable-network: false
    disable-implicit-base64-encoding: false

  # Queue Configuration
  queue:
    max-size: 100
    max-submission-batch-size: 20

  # Execution Limits - Defaults
  execution:
    number-of-runs: 1
    cpu-time-limit: 5.0
    cpu-extra-time: 1.0
    wall-time-limit: 10.0
    memory-limit: 128000 # KB
    stack-limit: 64000 # KB
    max-processes-and-or-threads: 60
    max-file-size: 1024 # KB
    enable-per-process-and-thread-time-limit: false
    enable-per-process-and-thread-memory-limit: false
    redirect-stderr-to-stdout: false

    # Maximum Limits
    max-number-of-runs: 20
    max-cpu-time-limit: 15.0
    max-cpu-extra-time: 5.0
    max-wall-time-limit: 20.0
    max-memory-limit: 512000 # KB
    max-stack-limit: 128000 # KB
    max-max-processes-and-or-threads: 120
    max-max-file-size: 4096 # KB
    max-extract-size: 10240 # KB

    # Permission Controls
    allow-enable-per-process-and-thread-time-limit: true
    allow-enable-per-process-and-thread-memory-limit: true

  # Compiler Configuration
  compiler:
    allowed-languages: ""

  # Callback Configuration
  callbacks:
    max-tries: 3
    timeout: 5.0

  # Cache Configuration
  cache:
    submission-cache-duration: 1.0

  # Docker Configuration
  docker:
    host: ${DOCKER_HOST:unix:///var/run/docker.sock}
    registry-url: "docker.io"
    max-concurrent-containers: 10
    container-timeout: 300
    api-version: ""
    tls-verify: false
    cert-path: ""

  # Container Pool Configuration
  container-pool:
    min-size: 5
    max-size: 20
    max-idle-time: 300000 # 5 minutes in milliseconds
    max-uses: 100
    health-check-interval: 30000 # 30 seconds
    image: "judge0/compilers:latest"

  # Docker Execution Configuration
  docker-execution:
    container-timeout: 30000 # 30 seconds to acquire container
    cleanup-async: true # Async cleanup for better performance

  # Security Configuration
  security:
    sandbox-user: "judge"
  #    allowed-syscalls: "read,write,exit,exit_group"

  # CORS Configuration
  cors:
    allowed-origins: ""
    disallowed-origins: ""
    allowed-ips: ""
    disallowed-ips: ""

  # Web Configuration
  web:
    request-timeout: 30
    connection-timeout: 10

  # JobRunr Configuration
  jobrunr:
    worker-count: 4
    job-timeout: 300
    polling-interval: 1
    delete-succeeded-jobs-after: 72
    permanently-delete-jobs-after: 168
    dashboard:
      enabled: false
      port: 8082

---
# Development Profile
spring:
  config:
    activate:
      on-profile: development
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: create-drop

logging:
  level:
    com.judge0: DEBUG
    org.springframework.web: DEBUG

judge0:
  maintenance:
    mode: false
  features:
    enable-submission-delete: true

# S3 (MinIO) 설정
s3:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin123
  bucket-name: pbl-images
  region: us-east-1
  base-url: http://localhost:9000

---
# Windows Profile
spring:
  config:
    activate:
      on-profile: windows

judge0:
  docker:
    host: "npipe:////./pipe/docker_engine" # Windows Docker Desktop
